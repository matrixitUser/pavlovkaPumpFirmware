#include "main.h"

#ifdef __SIGPWM_H__

#if 0
#define FUNCTLEN	256
const u16 costable[FUNCTLEN] = {0, 10, 39, 89, 158, 246, 355, 482, 630, 796, 982, 1187, 1411, 1654, 1915, 2196, 2494, 2811, 3146, 3499, 3869, 4257, 4662, 5084, 5522, 5977, 6448, 6935, 7438, 7956, 8488, 9036, 9597, 10173, 10762, 11365, 11980, 12608, 13248, 13900, 14563, 15237, 15922, 16616, 17321, 18035, 18758, 19489, 20228, 20975, 21728, 22489, 23256, 24028, 24806, 25588, 26375, 27166, 27960, 28756, 29556, 30357, 31160, 31963, 32768, 33572, 34375, 35178, 35979, 36779, 37575, 38369, 39160, 39947, 40729, 41507, 42279, 43046, 43807, 44560, 45307, 46046, 46777, 47500, 48214, 48919, 49613, 50298, 50972, 51635, 52287, 52927, 53555, 54170, 54773, 55362, 55938, 56499, 57047, 57579, 58097, 58600, 59087, 59558, 60013, 60451, 60873, 61278, 61666, 62036, 62389, 62724, 63041, 63339, 63620, 63881, 64124, 64348, 64553, 64739, 64905, 65053, 65180, 65289, 65377, 65446, 65496, 65525, 65535, 65525, 65496, 65446, 65377, 65289, 65180, 65053, 64905, 64739, 64553, 64348, 64124, 63881, 63620, 63339, 63041, 62724, 62389, 62036, 61666, 61278, 60873, 60451, 60013, 59558, 59087, 58600, 58097, 57579, 57047, 56499, 55938, 55362, 54773, 54170, 53555, 52927, 52287, 51635, 50972, 50298, 49613, 48919, 48214, 47500, 46777, 46046, 45307, 44560, 43807, 43046, 42279, 41507, 40729, 39947, 39160, 38369, 37575, 36779, 35979, 35178, 34375, 33572, 32768, 31963, 31160, 30357, 29556, 28756, 27960, 27166, 26375, 25588, 24806, 24028, 23256, 22489, 21728, 20975, 20228, 19489, 18758, 18035, 17321, 16616, 15922, 15237, 14563, 13900, 13248, 12608, 11980, 11365, 10762, 10173, 9597, 9036, 8488, 7956, 7438, 6935, 6448, 5977, 5522, 5084, 4662, 4257, 3869, 3499, 3146, 2811, 2494, 2196, 1915, 1654, 1411, 1187, 982, 796, 630, 482, 355, 246, 158, 89, 39, 10};
#define FUNCTABLE	costable
#elif 0
#define FUNCTLEN	128
const uint16_t costable[FUNCTLEN] = {0, 39, 158, 355, 630, 982, 1411, 1915, 2494, 3146, 3869, 4662, 5522, 6448, 7438, 8488, 9597, 10762, 11980, 13248, 14563, 15922, 17321, 18758, 20228, 21728, 23256, 24806, 26375, 27960, 29556, 31160, 32768, 34375, 35979, 37575, 39160, 40729, 42279, 43807, 45307, 46777, 48214, 49613, 50972, 52287, 53555, 54773, 55938, 57047, 58097, 59087, 60013, 60873, 61666, 62389, 63041, 63620, 64124, 64553, 64905, 65180, 65377, 65496, 65535, 65496, 65377, 65180, 64905, 64553, 64124, 63620, 63041, 62389, 61666, 60873, 60013, 59087, 58097, 57047, 55938, 54773, 53555, 52287, 50972, 49613, 48214, 46777, 45307, 43807, 42279, 40729, 39160, 37575, 35979, 34375, 32768, 31160, 29556, 27960, 26375, 24806, 23256, 21728, 20228, 18758, 17321, 15922, 14563, 13248, 11980, 10762, 9597, 8488, 7438, 6448, 5522, 4662, 3869, 3146, 2494, 1915, 1411, 982, 630, 355, 158, 39};
#define FUNCTABLE	costable
#else
#define FUNCTLEN	256
const u16 pulsetable[FUNCTLEN] = {0, 0, 0, 2463, 8420, 14378, 20336, 26294, 32252, 38209, 44167, 50125, 56083, 62041, 54024, 46006, 37989, 29972, 21955, 13937, 5920, 0, 0, 0, 0, 0, 0, 0, 0, 0, 874, 1018, 1162, 1311, 1529, 1748, 2036, 2329, 2621, 3058, 3495, 3555, 3614, 3674, 3734, 3793, 3853, 3912, 3972, 4031, 4091, 4151, 4369, 5243, 6117, 6991, 7864, 8738, 9612, 10486, 11360, 12233, 13107, 13981, 14855, 15729, 16602, 17476, 18022, 18569, 19115, 19661, 19879, 20098, 20229, 20404, 20535, 20404, 20229, 20098, 19879, 19661, 18918, 18219, 17476, 16228, 14980, 13731, 12483, 11235, 9986, 8738, 7864, 6991, 6117, 5243, 4369, 4114, 3859, 3604, 3350, 3095, 2840, 2884, 2927, 2971, 3015, 3058, 3102, 3146, 3189, 3233, 3277, 3464, 3651, 3839, 4026, 4213, 4400, 4588, 4588, 4369, 4151, 3867, 3583, 3299, 3015, 2731, 2447, 2163, 1879, 1595, 1311, 1267, 1223, 1180, 1136, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1092, 1748, 2403, 3058, 3714, 4369, 4675, 5024, 5374, 5680, 5855, 6029, 6204, 6379, 6554, 6335, 6117, 5898, 5680, 5024, 4369, 3714, 3058, 2403, 1748, 1092, 1058, 1024, 990, 956, 922, 887, 853, 819, 785, 751, 717, 683, 649, 614, 580, 546, 512, 478, 444, 410, 375, 341, 307, 273, 239, 205, 171, 137, 102, 68, 34, 0, 0, 0, 0};
//{15729, 14746, 13763, 18231, 22699, 27168, 31636, 36104, 40573, 45041, 49509, 53978, 58446, 62915, 56902, 50889, 44876, 38863, 32850, 26837, 20824, 14811, 8798, 2785, 4822, 6858, 8894, 10930, 12967, 15003, 17039, 17147, 17256, 17367, 17531, 17695, 17911, 18131, 18350, 18678, 19005, 19050, 19095, 19139, 19184, 19229, 19274, 19318, 19363, 19408, 19452, 19497, 19661, 20316, 20972, 21627, 22282, 22938, 23593, 24248, 24904, 25559, 26214, 26870, 27525, 28180, 28836, 29491, 29901, 30310, 30720, 31130, 31293, 31457, 31556, 31687, 31785, 31687, 31556, 31457, 31293, 31130, 30573, 30048, 29491, 28555, 27619, 26683, 25746, 24810, 23874, 22938, 22282, 21627, 20972, 20316, 19661, 19470, 19279, 19087, 18896, 18705, 18514, 18547, 18579, 18612, 18645, 18678, 18711, 18743, 18776, 18809, 18842, 18982, 19122, 19263, 19403, 19544, 19684, 19825, 19825, 19661, 19497, 19284, 19071, 18858, 18645, 18432, 18219, 18006, 17793, 17580, 17367, 17334, 17302, 17269, 17236, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17203, 17695, 18186, 18678, 19169, 19661, 19890, 20152, 20414, 20644, 20775, 20906, 21037, 21168, 21299, 21135, 20972, 20808, 20644, 20152, 19661, 19169, 18678, 18186, 17695, 17203, 17178, 17152, 17126, 17101, 17075, 17050, 17024, 16998, 16973, 16947, 16922, 16896, 16870, 16845, 16819, 16794, 16768, 16742, 16717, 16691, 16666, 16640, 16614, 16589, 16563, 16538, 16512, 16486, 16461, 16435, 16410, 16384, 16220, 16056, 15892};
#define FUNCTABLE	pulsetable
#endif
#define PWM_DIV(x)	((x)>>0)
#define SIGPWM_SERVICE		0x1000


PRIVATE u8 x = 0;
PRIVATE void _Next(void)
{
	++x;
#if FUNCTLEN < 256
	if(x >= FUNCTLEN) x = 0;
#endif
	TIM_SetCompare2(TIM2, PWM_DIV(FUNCTABLE[x]));
}

PUBLIC void TIMER_SIGPWM()
{
	//GPIO_CPU_LED_ON;
	if(TIM_GetITStatus(TIM2, TIM_IT_Update))
	{
		_Next();
		TIM_ClearITPendingBit(TIM2, TIM_IT_Update);
	}
}

PUBLIC void SigPwm_Init(void)
{
#if defined(GPIO_SIGPWM_LED_PORT)
    GPIO_InitTypeDef GPIO_InitStructure;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_InitStructure.GPIO_Pin   = GPIO_SIGPWM_LED_PIN;
    GPIO_InitStructure.GPIO_Mode  = GPIO_Mode_AF_PP;
    GPIO_Init(GPIO_SIGPWM_LED_PORT, &GPIO_InitStructure);

    //GPIO_PinRemapConfig(GPIO_Remap_TIM16, ENABLE);

	TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStruct;
	TIM_TimeBaseStructInit(&TIM_TimeBaseInitStruct);
	TIM_TimeBaseInitStruct.TIM_Prescaler = 1;
	TIM_TimeBaseInitStruct.TIM_Period = PWM_DIV(0xFFFF);
	TIM_TimeBaseInit(TIM2, &TIM_TimeBaseInitStruct);

	TIM_OCInitTypeDef TIM_OCInitStruct;
	TIM_OCStructInit(&TIM_OCInitStruct);
	TIM_OCInitStruct.TIM_OCMode = TIM_OCMode_PWM1;
	TIM_OCInitStruct.TIM_OutputState = TIM_OutputState_Enable;
	TIM_OCInitStruct.TIM_Pulse = SIGPWM_SERVICE;
	TIM_OC2Init(TIM2, &TIM_OCInitStruct);

	TIM_Cmd(TIM2, ENABLE);

	//TIM_SelectCCDMA(TIM2, DISABLE);
	//TIM_DMAConfig(TIM2, TIM_DMABase_CCR1, TIM_DMABurstLength_1Transfer);
	//TIM_DMACmd(TIM2, TIM_DMA_Update, ENABLE);

	TIM_ITConfig(TIM2, TIM_IT_Update, DISABLE);

	NVIC_EnableIRQ(TIM2_IRQn);
	NVIC_SetPriority(TIM2_IRQn, NVIC_PRIORITY_PWM);
#endif
}

//*PUBLIC inline void SigPwm_Cmd(FunctionalState NewState)
PUBLIC  void SigPwm_Cmd(FunctionalState NewState)
{
#if defined(GPIO_SIGPWM_LED_PORT)
	TIM_ITConfig(TIM2, TIM_IT_Update, NewState);
#endif
}

#endif
